"use strict";var se=Object.create;var I=Object.defineProperty,oe=Object.defineProperties,ae=Object.getOwnPropertyDescriptor,ce=Object.getOwnPropertyDescriptors,le=Object.getOwnPropertyNames,H=Object.getOwnPropertySymbols,ue=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable;var B=i=>{throw TypeError(i)};var K=(i,e,t)=>e in i?I(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,L=(i,e)=>{for(var t in e||(e={}))_.call(e,t)&&K(i,t,e[t]);if(H)for(var t of H(e))me.call(e,t)&&K(i,t,e[t]);return i},$=(i,e)=>oe(i,ce(e));var pe=(i,e)=>{for(var t in e)I(i,t,{get:e[t],enumerable:!0})},Q=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of le(e))!_.call(i,s)&&s!==t&&I(i,s,{get:()=>e[s],enumerable:!(r=ae(e,s))||r.enumerable});return i};var A=(i,e,t)=>(t=i!=null?se(ue(i)):{},Q(e||!i||!i.__esModule?I(t,"default",{value:i,enumerable:!0}):t,i)),de=i=>Q(I({},"__esModule",{value:!0}),i);var J=(i,e,t)=>e.has(i)||B("Cannot "+t);var n=(i,e,t)=>(J(i,e,"read from private field"),t?t.call(i):e.get(i)),u=(i,e,t)=>e.has(i)?B("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),g=(i,e,t,r)=>(J(i,e,"write to private field"),r?r.call(i,t):e.set(i,t),t);var l=(i,e,t)=>new Promise((r,s)=>{var o=p=>{try{h(t.next(p))}catch(f){s(f)}},c=p=>{try{h(t.throw(p))}catch(f){s(f)}},h=p=>p.done?r(p.value):Promise.resolve(p.value).then(o,c);h((t=t.apply(i,e)).next())});var we={};pe(we,{EmailTool:()=>D,EntitiesClient:()=>v,EntityClient:()=>R,FileTool:()=>M,LumiAuthClient:()=>x,LumiClient:()=>N,ToolsClient:()=>O,createClient:()=>ye});module.exports=de(we);var re=require("uuid");var Y=A(require("crypto-js/enc-base64")),z=A(require("crypto-js/enc-hex")),Z=A(require("crypto-js/hmac-sha256")),X=A(require("crypto-js/sha256")),W=A(require("object-hash")),ee=require("ofetch");var E=class extends Error{constructor(t,r){super(r);this.name="LumiError";this.code=t}};var ge="6QrJZ7pFCmBZAeIJF7IArvkCz+EtzA0RVcpHkiQIsQyhs7QtCS9P+CueZdHfB2OtJcgX3BbqY9pfpWeAVTqCwQ==";function V(i){return encodeURIComponent(i).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}function he(i){return e=>{let{options:t}=e,r=Math.floor(Date.now()/1e3).toString(),s=Math.random().toString(36).substring(2,15),o=L({},t.query),c=Object.keys(o).sort().map(w=>`${V(w)}=${V(String(o[w]))}`).join("&"),h={"x-timestamp":r,"x-nonce":s},p=Object.keys(h).sort().map(w=>`${w}:${h[w]}`).join(`
`),f=t.body&&!(t.body instanceof FormData)?JSON.stringify(t.body):"",k=(0,X.default)(f).toString(z.default),S=[c,p,k].join(`
`);console.warn(`Client-side Canonical Request V3:
`,S);let d=Y.default.stringify((0,Z.default)(S,i)),T=new Headers(t.headers);Object.entries(h).forEach(([w,ne])=>{T.set(w,ne)}),T.set("X-Sign",d),t.headers=T}}var G=new Map;function fe(i,e){var o;e.body instanceof FormData&&(e=$(L({},e),{body:Array.from(e.body.entries())}));let t=(0,W.default)([i,e]),r=Date.now(),s=((o=G.get(t))==null?void 0:o.filter(c=>r-c<1e3))||[];if(s.length>=4)throw new E(429,"Too many requests");s.push(r),G.set(t,s)}function a(i,e,t={}){return i.auth.accessToken&&(t.headers=L({Authorization:`Bearer ${i.auth.accessToken}`},t.headers)),fe(e,t),(0,ee.ofetch)(e,$(L({baseURL:i.config.apiBaseUrl},t),{onRequest:he(ge)}))}function te(){var i,e;return(e=(i=document.querySelector('link[rel="icon"]'))==null?void 0:i.href)!=null?e:null}function ie(){var i;return(i=document.title)!=null?i:null}function j(i,e,t=localStorage){let r=t.getItem(i),s=e?JSON.stringify(e):null;s?t.setItem(i,s):t.removeItem(i),window.dispatchEvent(new StorageEvent("storage",{key:i,oldValue:r,newValue:s,storageArea:t}))}function F(i,e=localStorage){let t=e.getItem(i);try{return t?JSON.parse(t):null}catch(r){return null}}var y,q,x=class{constructor(e){u(this,y);u(this,q,`lumi-auth-${(0,re.v4)()}`);g(this,y,e)}get accessToken(){return F("lumi-access-token")}set accessToken(e){j("lumi-access-token",e)}get user(){return F("lumi-user")}set user(e){j("lumi-user",e)}get isAuthenticated(){return!!this.accessToken}signIn(){let r=(window.screen.width-800)/2,s=(window.screen.height-600)/2,o=window.open(n(this,y).config.authOrigin,n(this,q),`width=800,height=600,left=${r},top=${s}`),c;return new Promise((h,p)=>{if(!o)return p(new Error("Open auth window failed"));let f=setInterval(()=>{o.closed&&p(new Error("Auth window closed"))},1e3),k=d=>{o.closed||(o.focus(),d.stopPropagation(),d.preventDefault())},S=({data:d,origin:T,source:w})=>{if(!(T!==n(this,y).config.authOrigin||w!==o))switch(d==null?void 0:d.type){case"lumi-ready":{o.postMessage({type:"lumi-init",data:{projectId:n(this,y).config.projectId,icon:te(),title:ie()}},n(this,y).config.authOrigin);break}case"lumi-sign-in":{if(d.data.projectId!==n(this,y).config.projectId)break;o.close(),window.focus(),this.accessToken=d.data.accessToken,this.user=d.data.user,h(d.data);break}}};window.addEventListener("message",S),document.addEventListener("click",k,!0),c=()=>{clearInterval(f),window.removeEventListener("message",S),document.removeEventListener("click",k,!0)}}).finally(()=>c==null?void 0:c())}signOut(){this.accessToken=null,this.user=null}refreshUser(){return l(this,null,function*(){let e=yield a(n(this,y),"/lm/user/info",{method:"POST"});if(e.code!==200)throw new Error(e.message);return this.user=e.data,e.data})}onAuthChange(e){let t=r=>{(r.key==="lumi-access-token"||r.key==="lumi-user"||r.key===null)&&e({isAuthenticated:this.isAuthenticated,user:this.user})};return window.addEventListener("storage",t),()=>{window.removeEventListener("storage",t)}}};y=new WeakMap,q=new WeakMap;var m,R=class{constructor(e,t){u(this,m);g(this,m,e),this.entityName=t}list(){return l(this,arguments,function*({filter:e,sort:t,limit:r,skip:s}={}){if(r){let o=yield a(n(this,m),this.uri("/find"),{method:"POST",body:{filter:e,sort:t,limit:r,skip:s}});if(o.code!==200)throw new Error(o.message);return o.data}else{let o=yield a(n(this,m),this.uri("/list"),{method:"POST",body:{filter:e,sort:t}});if(o.code!==200)throw new Error(o.message);return{total:o.data.length,list:o.data}}})}get(e){return l(this,null,function*(){let t=yield a(n(this,m),this.uri(`/${e}`),{method:"GET"});if(t.code!==200)throw new Error(t.message);return t.data})}create(e){return l(this,null,function*(){let t=yield a(n(this,m),this.uri(),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}createMany(e){return l(this,null,function*(){let t=yield a(n(this,m),this.uri("/batch"),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}update(e,t){return l(this,null,function*(){let r=yield a(n(this,m),this.uri(),{method:"PUT",body:{filter:{_id:e},update:t}});if(r.code!==200)throw new Error(r.message);return r.data})}delete(e){return l(this,null,function*(){let t=yield a(n(this,m),this.uri(`/${e}`),{method:"DELETE"});if(t.code!==200)throw new Error(t.message)})}deleteMany(e){return l(this,null,function*(){let t=yield a(n(this,m),this.uri("/batch-by-ids"),{method:"DELETE",params:{ids:e}});if(t.code!==200)throw new Error(t.message)})}uri(e=""){return`/lm/${n(this,m).config.projectId}/${this.entityName}/documents${e}`}};m=new WeakMap;var P,v=class{constructor(e){u(this,P);return g(this,P,e),new Proxy(this,{get(t,r){return r in t||(t[r]=new R(n(t,P),r)),t[r]}})}};P=new WeakMap;var C,D=class{constructor(e){u(this,C);g(this,C,e)}send(p){return l(this,arguments,function*({to:e,subject:t,fromName:r,html:s,text:o="",replyTo:c,scheduledAt:h}){if(!e||!t||!s&&!o)throw new Error("Failed to send email: Missing required parameters.");typeof e=="string"&&(e=[e]),typeof c=="string"&&(c=[c]);let f=yield a(n(this,C),`/lm/${n(this,C).config.projectId}/email/send`,{method:"POST",body:{to:e,subject:t,fromName:r,html:s,text:o,replyTo:c,scheduledAt:h}});if(f.code!==200)throw new E(f.code,f.message)})}};C=new WeakMap;var b,M=class{constructor(e){u(this,b);g(this,b,e)}upload(e){return l(this,null,function*(){let t=new FormData;e.forEach(s=>{t.append("files",s)});let r=yield a(n(this,b),`/lm/${n(this,b).config.projectId}/file/batch`,{method:"POST",body:t});if(r.code!==200)throw new E(r.code,r.message);return r.data})}delete(e){return l(this,null,function*(){let t=yield a(n(this,b),`/lm/${n(this,b).config.projectId}/file/batch`,{method:"DELETE",body:{fileUrls:e}});if(t.code!==200)throw new E(t.code,t.message)})}};b=new WeakMap;var U,O=class{constructor(e){u(this,U);g(this,U,e),this.email=new D(e),this.file=new M(e)}};U=new WeakMap;var N=class{constructor(e){this.config=e,this.auth=new x(this),this.entities=new v(this),this.tools=new O(this)}};function ye(i){return new N(i)}0&&(module.exports={EmailTool,EntitiesClient,EntityClient,FileTool,LumiAuthClient,LumiClient,ToolsClient,createClient});
//# sourceMappingURL=index.js.map